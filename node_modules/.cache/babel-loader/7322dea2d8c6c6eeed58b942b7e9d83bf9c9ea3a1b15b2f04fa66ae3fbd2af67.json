{"ast":null,"code":"import { Transform } from '../core/Transform.js';\nimport { Mesh } from '../core/Mesh.js';\nimport { Vec4 } from '../math/Vec4.js';\nexport class InstancedMesh extends Mesh {\n  constructor() {\n    super(...arguments);\n\n    // Skip renderer frustum culling\n    this.frustumCulled = false;\n    this.isInstancedMesh = true;\n  }\n  addFrustumCull() {\n    this.instanceTransforms = null;\n    this.instanceLightmapScaleOffset = null;\n    this.totalInstanceCount = 0;\n    this.frustumCullFunction = null;\n    this.instanceRenderList = null;\n\n    // Get instanced mesh\n    if (!this.geometry.attributes.instanceMatrix) console.error(\"mesh \".concat(this.name ? \"\\\"\".concat(this.name, \"\\\" \") : \"\", \"missing instanceMatrix attribute; unable to frustum cull\"));\n\n    // Make list of transforms from instanceMatrix\n    const matrixData = this.geometry.attributes.instanceMatrix.data;\n    this.instanceTransforms = [];\n    for (let i = 0, j = 0; i < matrixData.length; i += 16, j++) {\n      const transform = new Transform();\n      transform.index = j;\n      transform.matrix.fromArray(matrixData, i);\n      transform.decompose();\n      this.instanceTransforms.push(transform);\n      // Add transforms to parent to update world matrices\n      transform.setParent(this.parent);\n    }\n    this.totalInstanceCount = this.instanceTransforms.length;\n\n    // Check for lightmap attributes - attach to transform\n    if (!!this.geometry.attributes.lightmapScaleOffset) {\n      const lightmapData = this.geometry.attributes.lightmapScaleOffset.data;\n      for (let i = 0, j = 0; i < lightmapData.length; i += 4, j++) {\n        this.instanceTransforms[j].lightmapData = new Vec4().fromArray(lightmapData, i);\n      }\n    }\n    this.frustumCullFunction = _ref => {\n      let {\n        camera\n      } = _ref;\n      // frustum cull transforms each frame - pass world matrix\n      this.instanceRenderList = [];\n      this.instanceTransforms.forEach(transform => {\n        if (!camera.frustumIntersectsMesh(this, transform.worldMatrix)) return;\n        this.instanceRenderList.push(transform);\n      });\n\n      // update instanceMatrix and instancedCount with visible\n      this.instanceRenderList.forEach((transform, i) => {\n        transform.matrix.toArray(this.geometry.attributes.instanceMatrix.data, i * 16);\n\n        // Update lightmap attr\n        if (transform.lightmapData) {\n          transform.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data, i * 4);\n          this.geometry.attributes.lightmapScaleOffset.needsUpdate = true;\n        }\n      });\n      this.geometry.instancedCount = this.instanceRenderList.length;\n      this.geometry.attributes.instanceMatrix.needsUpdate = true;\n    };\n    this.onBeforeRender(this.frustumCullFunction);\n  }\n  removeFrustumCull() {\n    this.offBeforeRender(this.frustumCullFunction);\n    this.geometry.instancedCount = this.totalInstanceCount;\n    this.instanceTransforms.forEach((transform, i) => {\n      transform.matrix.toArray(this.geometry.attributes.instanceMatrix.data, i * 16);\n\n      // Update lightmap attr\n      if (transform.lightmapData) {\n        transform.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data, i * 4);\n        this.geometry.attributes.lightmapScaleOffset.needsUpdate = true;\n      }\n    });\n    this.geometry.attributes.instanceMatrix.needsUpdate = true;\n  }\n}","map":{"version":3,"names":["Transform","Mesh","Vec4","InstancedMesh","constructor","arguments","frustumCulled","isInstancedMesh","addFrustumCull","instanceTransforms","instanceLightmapScaleOffset","totalInstanceCount","frustumCullFunction","instanceRenderList","geometry","attributes","instanceMatrix","console","error","concat","name","matrixData","data","i","j","length","transform","index","matrix","fromArray","decompose","push","setParent","parent","lightmapScaleOffset","lightmapData","_ref","camera","forEach","frustumIntersectsMesh","worldMatrix","toArray","needsUpdate","instancedCount","onBeforeRender","removeFrustumCull","offBeforeRender"],"sources":["/home/nigro/Documents/personal_website/ngrlcu.github.io/node_modules/ogl/src/extras/InstancedMesh.js"],"sourcesContent":["import { Transform } from '../core/Transform.js';\nimport { Mesh } from '../core/Mesh.js';\nimport { Vec4 } from '../math/Vec4.js';\n\nexport class InstancedMesh extends Mesh {\n    constructor(...args) {\n        super(...args);\n\n        // Skip renderer frustum culling\n        this.frustumCulled = false;\n        this.isInstancedMesh = true;\n    }\n\n    addFrustumCull() {\n        this.instanceTransforms = null;\n        this.instanceLightmapScaleOffset = null;\n        this.totalInstanceCount = 0;\n        this.frustumCullFunction = null;\n        this.instanceRenderList = null;\n\n        // Get instanced mesh\n        if (!this.geometry.attributes.instanceMatrix)\n            console.error(`mesh ${this.name ? `\"${this.name}\" ` : ``}missing instanceMatrix attribute; unable to frustum cull`);\n\n        // Make list of transforms from instanceMatrix\n        const matrixData = this.geometry.attributes.instanceMatrix.data;\n        this.instanceTransforms = [];\n        for (let i = 0, j = 0; i < matrixData.length; i += 16, j++) {\n            const transform = new Transform();\n            transform.index = j;\n            transform.matrix.fromArray(matrixData, i);\n            transform.decompose();\n            this.instanceTransforms.push(transform);\n            // Add transforms to parent to update world matrices\n            transform.setParent(this.parent);\n        }\n        this.totalInstanceCount = this.instanceTransforms.length;\n\n        // Check for lightmap attributes - attach to transform\n        if (!!this.geometry.attributes.lightmapScaleOffset) {\n            const lightmapData = this.geometry.attributes.lightmapScaleOffset.data;\n            for (let i = 0, j = 0; i < lightmapData.length; i += 4, j++) {\n                this.instanceTransforms[j].lightmapData = new Vec4().fromArray(lightmapData, i);\n            }\n        }\n\n        this.frustumCullFunction = ({ camera }) => {\n            // frustum cull transforms each frame - pass world matrix\n            this.instanceRenderList = [];\n            this.instanceTransforms.forEach((transform) => {\n                if (!camera.frustumIntersectsMesh(this, transform.worldMatrix)) return;\n                this.instanceRenderList.push(transform);\n            });\n\n            // update instanceMatrix and instancedCount with visible\n            this.instanceRenderList.forEach((transform, i) => {\n                transform.matrix.toArray(this.geometry.attributes.instanceMatrix.data, i * 16);\n\n                // Update lightmap attr\n                if (transform.lightmapData) {\n                    transform.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data, i * 4);\n                    this.geometry.attributes.lightmapScaleOffset.needsUpdate = true;\n                }\n            });\n            this.geometry.instancedCount = this.instanceRenderList.length;\n            this.geometry.attributes.instanceMatrix.needsUpdate = true;\n        };\n\n        this.onBeforeRender(this.frustumCullFunction);\n    }\n\n    removeFrustumCull() {\n        this.offBeforeRender(this.frustumCullFunction);\n        this.geometry.instancedCount = this.totalInstanceCount;\n        this.instanceTransforms.forEach((transform, i) => {\n            transform.matrix.toArray(this.geometry.attributes.instanceMatrix.data, i * 16);\n\n            // Update lightmap attr\n            if (transform.lightmapData) {\n                transform.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data, i * 4);\n                this.geometry.attributes.lightmapScaleOffset.needsUpdate = true;\n            }\n        });\n        this.geometry.attributes.instanceMatrix.needsUpdate = true;\n    }\n}\n"],"mappings":"AAAA,SAASA,SAAS,QAAQ,sBAAsB;AAChD,SAASC,IAAI,QAAQ,iBAAiB;AACtC,SAASC,IAAI,QAAQ,iBAAiB;AAEtC,OAAO,MAAMC,aAAa,SAASF,IAAI,CAAC;EACpCG,WAAWA,CAAA,EAAU;IACjB,KAAK,CAAC,GAAAC,SAAO,CAAC;;IAEd;IACA,IAAI,CAACC,aAAa,GAAG,KAAK;IAC1B,IAAI,CAACC,eAAe,GAAG,IAAI;EAC/B;EAEAC,cAAcA,CAAA,EAAG;IACb,IAAI,CAACC,kBAAkB,GAAG,IAAI;IAC9B,IAAI,CAACC,2BAA2B,GAAG,IAAI;IACvC,IAAI,CAACC,kBAAkB,GAAG,CAAC;IAC3B,IAAI,CAACC,mBAAmB,GAAG,IAAI;IAC/B,IAAI,CAACC,kBAAkB,GAAG,IAAI;;IAE9B;IACA,IAAI,CAAC,IAAI,CAACC,QAAQ,CAACC,UAAU,CAACC,cAAc,EACxCC,OAAO,CAACC,KAAK,SAAAC,MAAA,CAAS,IAAI,CAACC,IAAI,QAAAD,MAAA,CAAO,IAAI,CAACC,IAAI,aAAS,6DAA0D,CAAC;;IAEvH;IACA,MAAMC,UAAU,GAAG,IAAI,CAACP,QAAQ,CAACC,UAAU,CAACC,cAAc,CAACM,IAAI;IAC/D,IAAI,CAACb,kBAAkB,GAAG,EAAE;IAC5B,KAAK,IAAIc,CAAC,GAAG,CAAC,EAAEC,CAAC,GAAG,CAAC,EAAED,CAAC,GAAGF,UAAU,CAACI,MAAM,EAAEF,CAAC,IAAI,EAAE,EAAEC,CAAC,EAAE,EAAE;MACxD,MAAME,SAAS,GAAG,IAAI1B,SAAS,CAAC,CAAC;MACjC0B,SAAS,CAACC,KAAK,GAAGH,CAAC;MACnBE,SAAS,CAACE,MAAM,CAACC,SAAS,CAACR,UAAU,EAAEE,CAAC,CAAC;MACzCG,SAAS,CAACI,SAAS,CAAC,CAAC;MACrB,IAAI,CAACrB,kBAAkB,CAACsB,IAAI,CAACL,SAAS,CAAC;MACvC;MACAA,SAAS,CAACM,SAAS,CAAC,IAAI,CAACC,MAAM,CAAC;IACpC;IACA,IAAI,CAACtB,kBAAkB,GAAG,IAAI,CAACF,kBAAkB,CAACgB,MAAM;;IAExD;IACA,IAAI,CAAC,CAAC,IAAI,CAACX,QAAQ,CAACC,UAAU,CAACmB,mBAAmB,EAAE;MAChD,MAAMC,YAAY,GAAG,IAAI,CAACrB,QAAQ,CAACC,UAAU,CAACmB,mBAAmB,CAACZ,IAAI;MACtE,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEC,CAAC,GAAG,CAAC,EAAED,CAAC,GAAGY,YAAY,CAACV,MAAM,EAAEF,CAAC,IAAI,CAAC,EAAEC,CAAC,EAAE,EAAE;QACzD,IAAI,CAACf,kBAAkB,CAACe,CAAC,CAAC,CAACW,YAAY,GAAG,IAAIjC,IAAI,CAAC,CAAC,CAAC2B,SAAS,CAACM,YAAY,EAAEZ,CAAC,CAAC;MACnF;IACJ;IAEA,IAAI,CAACX,mBAAmB,GAAGwB,IAAA,IAAgB;MAAA,IAAf;QAAEC;MAAO,CAAC,GAAAD,IAAA;MAClC;MACA,IAAI,CAACvB,kBAAkB,GAAG,EAAE;MAC5B,IAAI,CAACJ,kBAAkB,CAAC6B,OAAO,CAAEZ,SAAS,IAAK;QAC3C,IAAI,CAACW,MAAM,CAACE,qBAAqB,CAAC,IAAI,EAAEb,SAAS,CAACc,WAAW,CAAC,EAAE;QAChE,IAAI,CAAC3B,kBAAkB,CAACkB,IAAI,CAACL,SAAS,CAAC;MAC3C,CAAC,CAAC;;MAEF;MACA,IAAI,CAACb,kBAAkB,CAACyB,OAAO,CAAC,CAACZ,SAAS,EAAEH,CAAC,KAAK;QAC9CG,SAAS,CAACE,MAAM,CAACa,OAAO,CAAC,IAAI,CAAC3B,QAAQ,CAACC,UAAU,CAACC,cAAc,CAACM,IAAI,EAAEC,CAAC,GAAG,EAAE,CAAC;;QAE9E;QACA,IAAIG,SAAS,CAACS,YAAY,EAAE;UACxBT,SAAS,CAACS,YAAY,CAACM,OAAO,CAAC,IAAI,CAAC3B,QAAQ,CAACC,UAAU,CAACmB,mBAAmB,CAACZ,IAAI,EAAEC,CAAC,GAAG,CAAC,CAAC;UACxF,IAAI,CAACT,QAAQ,CAACC,UAAU,CAACmB,mBAAmB,CAACQ,WAAW,GAAG,IAAI;QACnE;MACJ,CAAC,CAAC;MACF,IAAI,CAAC5B,QAAQ,CAAC6B,cAAc,GAAG,IAAI,CAAC9B,kBAAkB,CAACY,MAAM;MAC7D,IAAI,CAACX,QAAQ,CAACC,UAAU,CAACC,cAAc,CAAC0B,WAAW,GAAG,IAAI;IAC9D,CAAC;IAED,IAAI,CAACE,cAAc,CAAC,IAAI,CAAChC,mBAAmB,CAAC;EACjD;EAEAiC,iBAAiBA,CAAA,EAAG;IAChB,IAAI,CAACC,eAAe,CAAC,IAAI,CAAClC,mBAAmB,CAAC;IAC9C,IAAI,CAACE,QAAQ,CAAC6B,cAAc,GAAG,IAAI,CAAChC,kBAAkB;IACtD,IAAI,CAACF,kBAAkB,CAAC6B,OAAO,CAAC,CAACZ,SAAS,EAAEH,CAAC,KAAK;MAC9CG,SAAS,CAACE,MAAM,CAACa,OAAO,CAAC,IAAI,CAAC3B,QAAQ,CAACC,UAAU,CAACC,cAAc,CAACM,IAAI,EAAEC,CAAC,GAAG,EAAE,CAAC;;MAE9E;MACA,IAAIG,SAAS,CAACS,YAAY,EAAE;QACxBT,SAAS,CAACS,YAAY,CAACM,OAAO,CAAC,IAAI,CAAC3B,QAAQ,CAACC,UAAU,CAACmB,mBAAmB,CAACZ,IAAI,EAAEC,CAAC,GAAG,CAAC,CAAC;QACxF,IAAI,CAACT,QAAQ,CAACC,UAAU,CAACmB,mBAAmB,CAACQ,WAAW,GAAG,IAAI;MACnE;IACJ,CAAC,CAAC;IACF,IAAI,CAAC5B,QAAQ,CAACC,UAAU,CAACC,cAAc,CAAC0B,WAAW,GAAG,IAAI;EAC9D;AACJ","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}